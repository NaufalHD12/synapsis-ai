<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapsis AI - CV Filtering System</title>
    
    <!-- Styling & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Pustaka JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
    </script>
    
    <!-- Alpine.js Logic -->
    <script>
        function synapsisApp() {
            return {
                jd: { filename: null, text: '' },
                cv: { files: [], data: [] },
                results: [],
                isLoading: false,
                statusText: 'Mulai Analisis',
                errorMessage: '',
                isReadyToProcess() {
                    return this.jd.text && this.cv.data.length > 0 && !this.isLoading;
                },
                resetAll() {
                    this.jd = { filename: null, text: '' };
                    this.cv = { files: [], data: [] };
                    this.results = [];
                    this.isLoading = false;
                    this.statusText = 'Mulai Analisis';
                    this.errorMessage = '';
                    document.getElementById('jd-input').value = '';
                    document.getElementById('cv-input').value = '';
                },
                async parsePdf(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const pdf = await pdfjsLib.getDocument({ data: event.target.result }).promise;
                                let fullText = '';
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const textContent = await page.getTextContent();
                                    fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                                }
                                resolve(fullText);
                            } catch (error) { reject(error); }
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(file);
                    });
                },
                async handleJdUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    this.jd = { filename: null, text: '' };
                    this.jd.filename = file.name;
                    this.statusText = 'Membaca JD...';
                    this.isLoading = true;
                    try {
                        this.jd.text = await this.parsePdf(file);
                    } catch (e) {
                        this.errorMessage = "Gagal membaca file JD.";
                    } finally {
                        this.isLoading = false;
                        this.statusText = 'Mulai Analisis';
                    }
                },
                async handleCvUpload(event) {
                    this.cv.files = Array.from(event.target.files);
                    if (this.cv.files.length === 0) return;
                    this.statusText = `Membaca ${this.cv.files.length} CV...`;
                    this.isLoading = true;
                    try {
                        const parsePromises = this.cv.files.map(file =>
                            this.parsePdf(file).then(text => ({ filename: file.name, text }))
                        );
                        this.cv.data = await Promise.all(parsePromises);
                    } catch (e) {
                        this.errorMessage = "Gagal membaca file CV.";
                        this.cv.data = [];
                    } finally {
                        this.isLoading = false;
                        this.statusText = 'Mulai Analisis';
                    }
                },
                async processFiles() {
                    if (!this.isReadyToProcess()) return;
                    this.isLoading = true;
                    this.results = [];
                    this.errorMessage = '';
                    this.statusText = 'Mengirim data ke server...';
                    try {
                        const response = await fetch('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jdText: this.jd.text, cvData: this.cv.data }) });
                        this.statusText = 'Menunggu analisis dari AI...';
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => null);
                            throw new Error(errorData?.error || `Server error: ${response.status}`);
                        }
                        this.results = await response.json();
                        if (this.results.length === 0) {
                            this.errorMessage = "AI tidak mengembalikan hasil.";
                        }
                    } catch (error) {
                        this.errorMessage = `Gagal memproses: ${error.message}`;
                    } finally {
                        this.isLoading = false;
                        this.statusText = 'Mulai Analisis';
                    }
                },
                async downloadReport() {
                    if (this.results.length === 0) return;
                    try {
                        const response = await fetch('/api/download_excel', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.results) });
                        if (!response.ok) throw new Error('Gagal membuat file Excel.');
                        const blob = await response.blob();
                        const link = document.createElement("a");
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", "hasil_penyaringan_synapsis_ai.xlsx");
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    } catch (error) {
                        this.errorMessage = `Gagal mengunduh Laporan: ${error.message}`;
                    }
                }
            };
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Styling Kustom -->
    <style>
        html { font-family: 'Inter', sans-serif; }
        .spinner { border-top-color: #0d9488; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        [x-cloak] { display: none !important; }
        .upload-box { transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .upload-box:hover { border-color: #0d9488; background-color: #f0fdfa; }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 antialiased">
    
    <div x-data="synapsisApp()" class="min-h-screen flex flex-col">
        
        <header class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-3">
                        <div class="bg-teal-600 p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10c0-4.42-2.87-8.17-6.84-9.5c-.5-.16-1.16-.03-1.66.33c-.51.36-.8.93-.8 1.54v2.53c0 .6.3 1.16.8 1.5c.5.34 1.16.47 1.66.32c2.93-1 5.2-3.65 5.2-6.85a8 8 0 1 1-8 8c0-2.33 1.02-4.44 2.66-5.85c.4-.35.64-.86.64-1.4V2.5A2.5 2.5 0 0 0 12 2z"/></svg>
                        </div>
                        <h1 class="text-xl font-bold text-slate-800">Synapsis <span class="text-teal-600">AI</span></h1>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div x-show="errorMessage" x-cloak x-transition class="mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md flex justify-between items-center">
                <span x-text="errorMessage"></span>
                <button @click="errorMessage = ''" class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                
                <aside class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-semibold mb-4">1. Deskripsi Pekerjaan</h2>
                        <input type="file" id="jd-input" @change="handleJdUpload" class="hidden" accept=".pdf" :disabled="isLoading">
                        <label for="jd-input" :class="isLoading ? 'cursor-not-allowed' : ''" class="upload-box w-full border-2 border-dashed border-slate-300 rounded-lg p-6 text-center">
                            <p class="text-sm font-semibold text-teal-600" x-text="jd.filename || 'Unggah File PDF'"></p>
                            <p class="text-xs text-slate-500 mt-1">Seret & lepas atau klik untuk memilih</p>
                        </label>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-semibold mb-4">2. CV Kandidat</h2>
                        <input type="file" id="cv-input" @change="handleCvUpload" class="hidden" accept=".pdf" multiple :disabled="isLoading">
                        <label for="cv-input" :class="isLoading ? 'cursor-not-allowed' : ''" class="upload-box w-full border-2 border-dashed border-slate-300 rounded-lg p-6 text-center">
                            <p class="text-sm font-semibold text-teal-600">Unggah CV (bisa lebih dari satu)</p>
                            <p class="text-xs text-slate-500 mt-1">Pilih beberapa file sekaligus</p>
                        </label>
                        <div x-show="cv.files.length > 0" x-cloak class="mt-4 max-h-36 overflow-y-auto pr-2 text-sm">
                            <p class="font-medium mb-2" x-text="`${cv.files.length} file dipilih:`"></p>
                            <ul class="space-y-1.5"><template x-for="file in cv.files" :key="file.name"><li class="text-slate-600 truncate" x-text="file.name"></li></template></ul>
                        </div>
                    </div>

                    <div class="flex items-center gap-4 pt-2">
                        <button @click="processFiles" :disabled="!isReadyToProcess()" class="w-full bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center hover:bg-teal-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all duration-200 shadow-sm hover:shadow-md">
                            <span x-text="isLoading ? statusText : 'Mulai Analisis'"></span>
                            <div x-show="isLoading" class="spinner h-5 w-5 rounded-full border-2 border-t-white/20 border-white ml-2"></div>
                        </button>
                        <button @click="resetAll" title="Reset" class="p-3 bg-slate-200 text-slate-600 rounded-lg hover:bg-slate-300 transition shrink-0">Reset</button>
                    </div>
                </aside>

                <section class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-slate-200 min-h-[500px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Hasil Analisis</h2>
                        <button @click="downloadReport()" x-show="results.length > 0" x-cloak x-transition class="bg-green-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-green-700 transition flex items-center justify-center text-sm">
                           Unduh Laporan Excel
                        </button>
                    </div>
                    
                    <div class="flex-grow">
                        <div x-show="isLoading" x-transition class="h-full flex flex-col justify-center items-center text-center">
                            <div class="spinner h-12 w-12 rounded-full border-4 border-teal-100"></div>
                            <p class="mt-4 text-slate-600 font-semibold" x-text="statusText"></p>
                        </div>
                        <div x-show="results.length === 0 && !isLoading" x-transition class="h-full flex flex-col justify-center items-center text-center text-slate-500">
                            <p class="text-5xl mb-2">ðŸ’¡</p>
                            <p class="mt-2 max-w-xs">Hasil analisis akan muncul di sini setelah Anda memulai proses.</p>
                        </div>

                        <div x-show="results.length > 0 && !isLoading" x-cloak x-transition class="space-y-4">
                            <template x-for="(result, index) in results" :key="index">
                                <details class="group border border-slate-200 rounded-lg" :open="index === 0">
                                    <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-slate-50">
                                        <div class="flex items-center gap-4">
                                            <span class="px-4 py-2 text-xl font-bold rounded-lg" :class="{ 'bg-green-100 text-green-800': result.skor_kecocokan > 85, 'bg-yellow-100 text-yellow-800': result.skor_kecocokan > 70 && result.skor_kecocokan <= 85, 'bg-red-100 text-red-800': result.skor_kecocokan <= 70 }" x-text="result.skor_kecocokan"></span>
                                            <div>
                                                <h3 class="font-semibold text-slate-800" x-text="result.nama_kandidat"></h3>
                                                <p class="text-xs text-slate-500" x-text="result.original_filename"></p>
                                            </div>
                                        </div>
                                        <span class="text-slate-400 group-open:rotate-180 transition-transform">&#9660;</span>
                                    </summary>
                                    <div class="border-t border-slate-200 p-4 space-y-4">
                                        <p class="text-sm text-slate-600 bg-slate-50 p-3 rounded-md italic">" <span x-text="result.ringkasan_positif"></span> "</p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <h4 class="font-semibold text-slate-700 mb-2">Poin Kunci Cocok</h4>
                                                <ul class="space-y-1.5"><template x-for="poin in result.poin_kunci_cocok"><li class="text-sm text-slate-700 flex items-start gap-2"><span class="text-green-500 mt-1">&#10003;</span><span x-text="poin"></span></li></template></ul>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-slate-700 mb-2">Poin Perhatian</h4>
                                                <ul class="space-y-1.5"><template x-for="poin in result.poin_perhatian"><li class="text-sm text-slate-700 flex items-start gap-2"><span class="text-amber-500 mt-1">&#9656;</span><span x-text="poin"></span></li></template></ul>
                                            </div>
                                        </div>
                                        <p class="text-xs text-slate-400 text-right pt-2" x-text="`Bahasa CV: ${result.bahasa_terdeteksi}`"></p>
                                    </div>
                                </details>
                            </template>
                        </div>
                    </div>
                </section>
            </div>
        </main>
        
        <footer class="text-center py-4 text-sm text-slate-500">
            <p>&copy; 2025 Synapsis AI. All rights reserved.</p>
        </footer>
    </div>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('synapsisApp', synapsisApp);
        });
    </script>
</body>
</html>
